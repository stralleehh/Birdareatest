<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Greenland Airport & NAVAID Mapper</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }
    .popup-input { width: 100%; padding: 5px; margin-top: 5px; }
    .btn { background: red; color: white; padding: 5px; border: none; cursor: pointer; margin-top: 5px; }
    #clear-all { position: absolute; top: 10px; right: 10px; z-index: 1000; background: #ff4444; color: white; padding: 10px; border: none; cursor: pointer; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="clear-all">Clear All Markers</button>

<script>
// Initialize the map centered on Greenland
const map = L.map('map').setView([72, -40], 4);

// Load OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Define a smaller icon
const smallIcon = L.icon({
  iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
  iconSize: [16, 26], // Smaller size
  iconAnchor: [8, 26],
  popupAnchor: [1, -24]
});

// Load saved markers from local storage
let savedMarkers = JSON.parse(localStorage.getItem("greenlandMarkers")) || [];
savedMarkers.forEach(markerData => {
  addMarker(markerData.lat, markerData.lng, markerData.name, markerData.icao, markerData.navaid, false);
});

// Function to add a marker
function addMarker(lat, lng, name = "", icao = "", navaid = "", save = true) {
  const marker = L.marker([lat, lng], { icon: smallIcon, draggable: true }).addTo(map);

  function updatePopup() {
    marker.bindPopup(`
      <form onsubmit="handleSubmit(event, ${lat}, ${lng}, ${marker._leaflet_id})">
        <label>Airport Name:</label>
        <input type="text" class="popup-input name" value="${name}" />
        <label>ICAO Code:</label>
        <input type="text" class="popup-input icao" value="${icao}" />
        <label>NAVAID Info:</label>
        <input type="text" class="popup-input navaid" value="${navaid}" />
        <br>
        <button type="submit" class="btn">Submit</button>
        <button type="button" class="btn" onclick="removeMarker(${lat}, ${lng}, ${marker._leaflet_id})">Remove</button>
      </form>
    `).openPopup();
  }

  marker.on("click", updatePopup);
  
  marker.on("dragend", function () {
    let newLatLng = marker.getLatLng();
    removeMarker(lat, lng, marker._leaflet_id, false); 
    addMarker(newLatLng.lat, newLatLng.lng, name, icao, navaid, true);
  });

  updatePopup();
  if (save) saveMarker(lat, lng, name, icao, navaid);
}

// Handle form submission
function handleSubmit(event, lat, lng, markerId) {
  event.preventDefault();
  const form = event.target;
  const name = form.querySelector(".name").value;
  const icao = form.querySelector(".icao").value;
  const navaid = form.querySelector(".navaid").value;

  // Save marker
  saveMarker(lat, lng, name, icao, navaid);

  // Close the popup
  map.eachLayer(layer => {
    if (layer._leaflet_id == markerId) {
      layer.closePopup();
    }
  });

  return false;
}

// Save marker data in local storage
function saveMarker(lat, lng, name, icao, navaid) {
  let markers = JSON.parse(localStorage.getItem("greenlandMarkers")) || [];
  markers = markers.filter(m => m.lat !== lat || m.lng !== lng);
  markers.push({ lat, lng, name, icao, navaid });
  localStorage.setItem("greenlandMarkers", JSON.stringify(markers));
}

// Remove marker from map and local storage
function removeMarker(lat, lng, markerId, reload = true) {
  let markers = JSON.parse(localStorage.getItem("greenlandMarkers")) || [];
  markers = markers.filter(m => m.lat !== lat || m.lng !== lng);
  localStorage.setItem("greenlandMarkers", JSON.stringify(markers));

  map.eachLayer(layer => {
    if (layer._leaflet_id == markerId) {
      map.removeLayer(layer);
    }
  });

  if (reload) location.reload();
}

// Clear all markers
function clearAllMarkers() {
  localStorage.removeItem("greenlandMarkers");
  location.reload();
}

// Add marker on map click
map.on("click", function (e) {
  addMarker(e.latlng.lat, e.latlng.lng);
});

// Event listener for "Clear All Markers"
document.getElementById("clear-all").addEventListener("click", clearAllMarkers);
</script>

</body>
</html>
